---
import WorksIndex from '../../_components/page.works/index.view';
import { createWorksRepository } from '../../_repositories';
import { createAuthRepository } from '../../_repositories';
import Layout from '../../layout.astro';

const { cookies } = Astro
const { searchParams } = Astro.url

const token = searchParams.get("token");

token && cookies.set("token", token, {
  httpOnly: true,
  secure: true,
  maxAge: 60 * 60 * 24 * 7,
});

const authRepo = createAuthRepository()
const isAuth = await authRepo.validate(cookies.get("token")?.value)

!isAuth && cookies.delete("token")

const workRepo = createWorksRepository(cookies.get("token")?.value);
const result = await workRepo.findList();

export const prerender = false;
---

<Layout title="Work" permalink="/work/" namespace="works">
  <WorksIndex posts={result!.works} total={Number(result!.totalCount)} namespace="works" />
</Layout>
