---
import WorkIndex from "../../_components/page/work/index.view";
import { formatCloudinaryAPI } from "../../_foundation/cloudinary";
import { createWorkRepository, createAuthRepository } from "../../_repositories";
import Layout from "../../layout.astro";

const { cookies } = Astro

let refreshToken: string | undefined

const val = Astro.url.searchParams.get("token")

if (val) {
  const maxAge = 60 * 60 * 24 * 7
  cookies.set("token", val, { httpOnly: true, secure: true, maxAge })

  refreshToken = val
}

refreshToken = refreshToken ?? cookies.get("token")?.value

const authRepo = createAuthRepository()
const isAuth = await authRepo.validate(refreshToken)

if (!isAuth) {
  cookies.delete("token")
  refreshToken = undefined
}

const reqHeaders = {
  "Content-Type": "application/json",
  ...(refreshToken && { "Authorization": `Bearer ${refreshToken}` })
}
const workRepo = createWorkRepository(reqHeaders)
const result = await workRepo.findList()

export const prerender = false
---

<Layout title="Work" permalink="/work/" namespace="work">
  <link
    slot="prependHead"
    as="image"
    crossorigin="anonymous"
    href={formatCloudinaryAPI(result!.works[0].mv["pc"].url, "f_auto,q_auto,w_1440")}
    rel="preload"
  />
  <link
    slot="prependHead"
    as="image"
    crossorigin="anonymous"
    href={formatCloudinaryAPI(result!.works[1].mv["pc"].url, "f_auto,q_auto,w_1440")}
    rel="preload"
  />
  <WorkIndex posts={result!.works} total={Number(result!.totalCount)} namespace="work" />
</Layout>
